# perf-map-agent

A java agent to generate `/tmp/perf-<pid>.map` files for just-in-time(JIT)-compiled methods for use with the [Linux `perf` tools](https://perf.wiki.kernel.org/index.php/Main_Page).

## Build

Make sure `JAVA_HOME` is configured to point to a JDK. Then run the following on the command line:
```sh
$ cd ..
$ cmake .
$ make
```

## Architecture

Linux `perf` tools will expect symbols for code executed from unknown memory regions at `/tmp/perf-<pid>.map`. This allows runtimes that
generate code on the fly to supply dynamic symbol mappings to be used with the `perf` suite of tools.

perf-map-agent is an agent that will generate such a mapping file for Java applications.

When the agent is attached it instructs the JVM to report code blobs generated by the JVM at runtime for various purposes. Most importantly,
this includes JIT-compiled methods but also various dynamically-generated infrastructure parts like the dynamically created interpreter, 
adaptors, and jump tables for virtual dispatch (see `vtable` and `itable` entries). The agent creates a `/tmp/perf-<pid>.map` file which
it fills with one line per code blob that maps a memory location to a code blob name.

The Java application takes the PID of a Java process as an argument and an arbitrary number of additional arguments which it passes to the agent.
It then attaches to the target process and instructs it to load the agent library.

## Command line scripts

The `bin` directory contains a set of shell scripts to combine common `perf` operations with creating the map file. The scripts will
use `sudo` to call `perf` scripts.

 - `create-java-perf-map.sh <pid> <options*>` takes a PID and options. It knows where to find libraries relative to the `bin` directory.
 - `perf-java-top <pid> <perf-top-options>` takes a PID and additional options to pass to `perf top`. Uses the agent to create a new
    `/tmp/perf-<pid>.map` and then calls `perf top` with the given options.
 - `perf-java-record-stack <pid> <perf-record-options>` takes a PID and additional options to pass to `perf record`. Runs
   `perf record -g -p <pid> <perf-record-options>` to collect performance data including stack traces. Afterwards it uses the agent to create a
   new `/tmp/perf-<pid>.map` file.
 - `perf-java-report-stack <pid> <perf-record-options>` calls first `perf-java-record-stack <pid> <perf-record-options>` and then runs
   `perf report` to directly analyze the captured data. You can call `perf report -i /tmp/perf-<pid>.data` again with any options after the
   script has exited to further analyze the data from the previous run.
 - `perf-java-flames <pid> <perf-record-options>` collects data with `perf-java-record-stack` and then creates a visualization
   using [@brendangregg's FlameGraph](https://github.com/brendangregg/FlameGraph) tools. To get meaningful stacktraces spanning several JIT-compiled methods,
   you need to run your JVM with `-XX:+PreserveFramePointer` (which is available starting from JDK8 update 60 build 19) as detailed
   in [ag netflix blog entry](http://techblog.netflix.com/2015/07/java-in-flames.html).
